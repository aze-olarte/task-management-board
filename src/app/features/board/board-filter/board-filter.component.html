<form
  [formGroup]="form"
  (ngSubmit)="onSubmit()"
  nz-form
  nzLayout="vertical"
  class="form"
  role="form"
  aria-labelledby="filtersFormTitle"
>
  <h2 id="filtersFormTitle" class="sr-only">Task Sorting and Filters</h2>

  <nz-divider nzText="Sort" role="separator"></nz-divider>
  <div formGroupName="sort" aria-label="Sort Options">
    <nz-form-item>
      <nz-form-label nzFor="field">Field</nz-form-label>
      <nz-form-control>
        <nz-select
          id="field"
          formControlName="field"
          nzAllowClear
          nzPlaceHolder="Select field"
          aria-label="Select sorting field"
        >
          <nz-option nzValue="dueDate" nzLabel="Due Date"></nz-option>
          <nz-option nzValue="priority" nzLabel="Priority"></nz-option>
          <nz-option nzValue="createdAt" nzLabel="Created Date"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label nzFor="dir">Direction</nz-form-label>
      <nz-form-control>
        <nz-select
          id="dir"
          formControlName="dir"
          nzPlaceHolder="Select direction"
          aria-label="Select sorting direction"
        >
          <nz-option nzValue="asc" nzLabel="Ascending"></nz-option>
          <nz-option nzValue="desc" nzLabel="Descending"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
  </div>

  <nz-divider nzText="Filters" role="separator"></nz-divider>
  <div formGroupName="filters" aria-label="Filter Options">
    <nz-form-item>
      <nz-form-label nzFor="text">Title or Description</nz-form-label>
      <nz-form-control>
        <nz-input-group [nzSuffix]="suffixTemplate">
          <input
            id="text"
            nz-input
            type="text"
            placeholder="Search by title or description"
            formControlName="text"
            aria-label="Search tasks by title or description"
          />
        </nz-input-group>

        <ng-template #suffixTemplate>
          <button
            type="button"
            nz-button
            nzType="default"
            nz-dropdown
            [nzDropdownMenu]="historyMenu"
            (nzVisibleChange)="onHistoryVisibleChange($event)"
            nzPlacement="bottomRight"
            aria-haspopup="menu"
            aria-label="Show search history"
          >
            <i
              nz-icon
              nzType="history"
              nzTheme="outline"
              aria-hidden="true"
            ></i>
          </button>
        </ng-template>

        <nz-dropdown-menu
          #historyMenu="nzDropdownMenu"
          class="search-history-dropdown"
          aria-label="Search history"
        >
          <ul nz-menu role="menu">
            @if (!searchHistory.length) {
            <li nz-menu-item role="menuitem" aria-disabled="true">
              No history
            </li>
            } @else { @for (term of searchHistory; track term) {
            <li
              nz-menu-item
              role="menuitem"
              (click)="applySearchHistory(term)"
              tabindex="0"
            >
              {{ term }}
            </li>
            } }
          </ul>
        </nz-dropdown-menu>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label nzFor="status">Status</nz-form-label>
      <nz-form-control>
        <nz-select
          id="status"
          formControlName="status"
          nzMode="multiple"
          nzAllowClear
          nzPlaceHolder="Select status"
          aria-label="Select task status"
        >
          <nz-option nzValue="todo" nzLabel="To Do"></nz-option>
          <nz-option nzValue="in-progress" nzLabel="In Progress"></nz-option>
          <nz-option nzValue="done" nzLabel="Done"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label nzFor="priority">Priority</nz-form-label>
      <nz-form-control>
        <nz-select
          id="priority"
          formControlName="priority"
          nzMode="multiple"
          nzAllowClear
          nzPlaceHolder="Select priority"
          aria-label="Select task priority"
        >
          <nz-option nzValue="low" nzLabel="Low"></nz-option>
          <nz-option nzValue="medium" nzLabel="Medium"></nz-option>
          <nz-option nzValue="high" nzLabel="High"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label nzFor="dueDate">Due Date</nz-form-label>
      <nz-form-control>
        <nz-range-picker
          id="dueDate"
          formControlName="dueDate"
          [nzFormat]="'MM/dd/yyyy'"
          nzPlaceHolder="Select date range"
          aria-label="Select due date range"
        ></nz-range-picker>
      </nz-form-control>
    </nz-form-item>
  </div>

  <div class="form-row" role="group" aria-label="Form actions">
    <nz-form-item class="flex-item">
      <nz-form-control>
        <button
          nz-button
          nzType="text"
          type="button"
          (click)="clear()"
          aria-label="Clear filters"
        >
          Clear
        </button>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item class="flex-item">
      <nz-form-control>
        <button
          nz-button
          nzType="default"
          type="submit"
          aria-label="Apply filters"
        >
          Apply Filters
        </button>
      </nz-form-control>
    </nz-form-item>
  </div>
</form>